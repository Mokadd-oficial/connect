<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Connect+ — Login</title>

  <!-- Fontes -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg: '#1C1C1C',
            surface: '#242424',
            accent: '#D64B36',
            white: '#FFFFFF',
            muted: '#BDBDBD',
          },
          borderRadius: { 'md': '12px' },
          boxShadow: { 'aria-elev-1': '0 6px 20px rgba(0,0,0,0.6)' },
          spacing: { 'gap-md': '16px' },
          fontFamily: {
            sans: ['Inter', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial'],
          }
        }
      }
    };
  </script>
</head>

<body class="bg-bg text-white antialiased font-sans min-h-screen flex items-center justify-center">

  <!-- CARD DE LOGIN -->
  <div class="bg-gradient-to-b from-white/2 to-transparent rounded-md p-8 shadow-aria-elev-1 border border-white/3 w-full max-w-md">
    <!-- Logo -->
    <div class="flex items-center justify-center gap-2.5 mb-8">
      <div class="w-9 h-5 rounded-full bg-transparent shadow-[inset_0_0_0_4px_#D64B36]"></div>
      <h1 class="text-2xl font-bold text-accent">Connect+</h1>
    </div>

    <h2 class="text-2xl font-bold text-white mb-2 text-center">Entrar no Connect +</h2>
    <p class="text-muted text-sm text-center mb-6">Login via API (FastAPI + PostgreSQL)</p>

    <form id="login-form" class="space-y-4">
      <div>
        <label for="login-email" class="block text-sm font-medium text-white mb-1">E-mail</label>
        <input id="login-email" type="email" placeholder="seu@empresa.com"
               class="w-full bg-surface border border-white/10 rounded-md px-3 py-2 text-white placeholder-muted focus:outline-none focus:ring-2 focus:ring-accent"
               required />
      </div>

      <div>
        <label for="login-password" class="block text-sm font-medium text-white mb-1">Senha</label>
        <input id="login-password" type="password" placeholder="Sua senha"
               class="w-full bg-surface border border-white/10 rounded-md px-3 py-2 text-white placeholder-muted focus:outline-none focus:ring-2 focus:ring-accent"
               required />
      </div>

      <div id="error-message" class="text-red-400 text-sm hidden">E-mail ou senha incorretos.</div>

      <button id="login-btn" type="submit"
              class="w-full flex items-center justify-center gap-2 p-3 rounded-[10px] bg-accent text-white border-none cursor-pointer font-semibold shadow-[0_6px_18px_rgba(214,75,54,0.12)] transition-all duration-300 hover:-translate-y-0.5 hover:shadow-[0_10px_26px_rgba(214,75,54,0.14)] active:translate-y-0">
        <span class="material-icons-outlined">login</span> Entrar
      </button>
    </form>

    <div class="mt-6 text-center">
      <a href="register.html" class="text-accent hover:underline text-sm">Criar conta</a>
      <span class="text-muted text-sm mx-2">•</span>
      <a href="home.html" class="text-accent hover:underline text-sm">Continuar como convidado</a>
    </div>

    <p class="text-muted text-xs text-center mt-4">
      Ao logar, guardamos token e usuário no localStorage (demo).
    </p>
  </div>

  <script>
    const API_BASE = "http://localhost:8000";

    function showError(msg) {
      const el = document.getElementById("error-message");
      el.textContent = msg || "E-mail ou senha incorretos.";
      el.classList.remove("hidden");
    }

    function hideError() {
      document.getElementById("error-message").classList.add("hidden");
    }

    function setLoading(isLoading) {
      const btn = document.querySelector("#login-form button[type='submit']");
      btn.disabled = isLoading;
      btn.style.opacity = isLoading ? "0.85" : "1";
    }

    document.getElementById("login-form").addEventListener("submit", async function (e) {
      e.preventDefault();
      hideError();
      setLoading(true);

      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value;

      try {
        const resp = await fetch(`${API_BASE}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });

        const data = await resp.json().catch(() => ({}));

        if (!resp.ok) {
          showError(data.detail || "Falha no login.");
          return;
        }

        // salva token + user
        localStorage.setItem("cp_token", data.access_token);
        localStorage.setItem("cp_user", JSON.stringify({
          user_id: data.user_id,
          name: data.full_name,
          email: data.email,
          role: data.role_code
        }));

        // mantém cp_state (do seu front) se ainda não existir
        if (!localStorage.getItem("cp_state")) {
          localStorage.setItem("cp_state", JSON.stringify({ xp: 0, level: 1, missions: {} }));
        }

        // redireciona por role
        if (data.role_code === "admin") {
          location.href = "admin.html";
        } else {
          location.href = "home.html";
        }

      } catch (err) {
        showError("Não consegui conectar na API. Confere se o backend está rodando na porta 8000.");
      } finally {
        setLoading(false);
      }
    });
  </script>

</body>
</html>